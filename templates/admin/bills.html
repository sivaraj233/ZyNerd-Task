{% extends "admin/admin_index.html" %} {% block content %}
<div class="content-wrapper" style="margin-top: -600px">
    <div class="container mt-5">
        <h1>Unpaid Bills</h1>
        <form>
            <div class="mb-3">
                <label for="customerSelect" class="form-label">Select Customer:</label>
                <select class="form-select" id="customerSelect" required name="customer">
                    {% for item in customer_details %}
                    <option value="{{item.customer_id}}">{{item.first_name}}</option>
                    {% endfor %}
                    <!-- Populate this dropdown with customer options -->
                    <!-- Add more options as needed -->
                </select>
            </div>
            <button type="button" class="btn btn-primary" onclick="searchCustomer()">
                Book Job
            </button>
        </form>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table m-0" id="customerTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bill in customer_details %}
                        <tr>
                            <td>{{ bill.job_date }}</td>
                            <td>{{ bill.first_name }}</td>
                            <td>{{ bill.total_cost }}</td>
                            <td>
                                <button type="button" class="btn btn-primary" onclick="paidBill('{{ bill.job_id}}')" >
                                    Mark as Paid
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function paidBill(id) {
        // Get values from the form
        var job_id = id;
        // Create an object with the data
        var data = {
            job_id: job_id,
        };
        console.log(data);
        // Send an AJAX request to your Flask route
        jQuery.ajax({
            type: "POST",
            url: "/paid", // Update with your actual route
            contentType: "application/json;charset=UTF-8",
            data: JSON.stringify(data),
            success: function (response) {
                var modal = $("#successModal");
                modal.find("#modalMessage").text("Paid Successfully");
                modal.modal("show");
                modal.on("hidden.bs.modal", function () {
                     location.reload();
                });
            },
            error: function (error) {
                console.error(error);
            },
        });
    }

    function searchCustomer() {
    var searchItem = $("#customerSelect").val();
    var data = {
      searchItem: searchItem,
    };
    console.log(data)
    // Send an AJAX request to your Flask route
    jQuery.ajax({
      type: "POST",
      url: "/search_customer", // Update with your actual route
      contentType: "application/json;charset=UTF-8",
      data: JSON.stringify(data),
      success: function (response) {
        $("#customerTable tbody").empty();
        // Update table with new data
        for (var i = 0; i < response.data.length; i++) {
          var item = response.data[i];
          var newRow =
            "<tr>" +
            "<td>" +
            (i + 1) +
            "</td>" +
            "<td>" +
            item.first_name +
            "</td>" +
            "<td>" +
            item.total_cost +
            "</td>" +
            "<td>" +
            "<button type='button' class='btn btn-primary' onclick='paidBill(" + item.job_id + ")'>" +
            "Mark as Paid" +
            "</button>" +
            "</td>" +
            "</tr>";

          // Append the new row to the table
          $("#customerTable tbody").append(newRow);
        }
      },
      error: function (error) {
        console.error(error);
      },
    });
  }
</script>
<div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="successModalLabel"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <h3 id="modalMessage"></h3>
                <p id="modalDetails"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}